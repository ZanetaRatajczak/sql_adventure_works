SELECT strftime('%Y', OrderDate) AS order_year,

       ProductID,

       SUM(OrderQty) AS total_sold,

       RANK() OVER (PARTITION BY strftime('%Y', OrderDate) ORDER BY SUM(OrderQty) DESC) AS rank_in_year

FROM SalesOrderDetail d

INNER JOIN SalesOrderHeader h ON d.SalesOrderID = h.SalesOrderID

GROUP BY order_year, ProductID

ORDER BY order_year, rank_in_year;

